<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <style>
        html, body {
            margin: 0;
            padding: 5px;
        }
    </style>
    <script src="/src/assets/libs/babel-standalone/babel.min.js"></script>
    <script>

        (() => {
            const script = document.createElement('script');
            script.type = 'importmap';
            script.textContent = JSON.stringify({"imports": top.window.__LIBS__}, null, 2);
            console.log(document);
            document.currentScript.after(script);
        })();

        (() => {

            // console.log(window.frameElement.previousElementSibling);
            const textarea = window.frameElement.previousElementSibling;

            const code = textarea.value;
            const template = textarea.getAttribute('data-template');


            const script = document.createElement('script');
            script.type = 'text/babel';
            script.setAttribute('data-type', 'module');
            script.setAttribute('data-presets', 'react');

            console.log(template);
            if(template !== 'undefined') {
                if(template === 'react') {

                    const newCode = code.replace(/^(\s*)export\s+default\s+/m, (s, before) => {
                        return `${before}\n ;const __MODULE__ = `;
                    });

                    const newCode2 = `
import { createRoot as __createRoot__  } from 'react-dom/client';


${newCode}


(() => {
const container = document.createElement('div');
document.body.appendChild(container);
const root = __createRoot__(container);
root.render(React.createElement(__MODULE__));
})();

                    `;

                    const { code: source } = Babel.transform(newCode2, {
                        // 'env',
                        presets: ['react'],
                        plugins: [],
                    });
                    console.log(source);


//                     const blob = new Blob([source], {
//                         type: 'application/javascript'
//                     });
//                     const url = URL.createObjectURL(blob);
// import App from '${url}';
// console.log(App);

//                     const newCode2 = `
// import React from 'react';
// import { createRoot } from 'react-dom/client';
// const container = document.createElement('div');
// document.body.appendChild(container);
// const root = createRoot(container);
// root.render(React.createElement(__MODULE__));
//                     `;
                    script.innerHTML = source;
                }
            } else {
                script.innerHTML = code;
            }
            document.currentScript.after(script);
        })();
    </script>


</head>
<body>
<!--<script type="text/babel" data-type="module" data-presets="react">-->
<!--</script>-->

<script>
    (() => {
        function debounce(fn, wait = 50) {
            let timer = null
            return function (...args) {
                if (timer) clearTimeout(timer)
                timer = setTimeout(() => {
                    fn.apply(this, args)
                }, wait)
            }
        }

        const topFrame = window.frameElement;
        if (topFrame) {
            const debouncedHandler = debounce(() => {
                const height = document.documentElement.offsetHeight;
                topFrame.style.height = (height + 10) + 'px';
            }, 0);
            const observe = new ResizeObserver(debouncedHandler);
            observe.observe(document.documentElement);
        }
    })();
</script>



</body>


</html>
