# 限制并发请求

实现一个并发请求函数concurrencyRequest(urls, maxNum)，要求如下：
• 要求最大并发数 maxNum
• 每当有一个请求返回，就留下一个空位，可以增加新的请求
• 所有请求完成后，结果按照 urls 里面的顺序依次打出（发送请求的函数可以直接使用fetch即可）


```javascript {demo type=module container=root}
function concurrencyRequest(urls, maxNum) {
    
    return new Promise((resolve) => {
        if(urls.length === 0) {
            resolve([]);
            return;
        }
        
        let num = 0;
        const result = new Map();
        const tasks = [];
        
        function returnResult() {
            const rs = Array.from(result.keys()).sort().map((k) => result.get(k));
            resolve(rs);
        }
        
        function createTask(url, index) {
            return {
                index,
                running: false,
                url,
            };
        }
         
        function addTask(url, index) {
            tasks.push(createTask(url, index));
            runTask();
        }
        function removeTask(task) {
            const index = tasks.indexOf(task);
            if(index!==-1) {
                tasks.splice(index, 1);
            }
        }
        function runTask() {
            if( num>=maxNum ) return;
            if( tasks.length === 0 ) {
                returnResult();
                return;
            }
            const task = tasks.find(t => !t.running);
            if(!task) return;
            num++;
            task.running = true;
            fetch(task.url).then(r=>r.json()).then((r) => {
                result.set(task.index, r);
                num--;
                removeTask(task);
                runTask();
            });
        }
        
        for(let i=0;i<urls.length;i++) {
            addTask(urls[i], i);
        }
    
    });
}

const urls = [];

for(let i=0;i<10;i++) {
    urls.push('/api/sleep?i='+i);
}

const container = document.getElementById('root');
container.innerHTML = '<button>click</button>';
container.addEventListener('click', async () => {
    console.log('start');

    const result = await concurrencyRequest(urls, 7);
    
    console.log('end');
    
    console.log(result);
}, false);

```

## rxjs

```javascript {demo type=module container=root}
import { range, filter, map, mergeMap, concatAll } from 'https://esm.sh/rxjs';
 
function concurrencyRequest(urls, maxNum) {
    range(1, 10)
    .pipe(
        mergeMap(i => fetch(`/api/sleep?i=${i}`).then(r=>r.json()), maxNum)
    )
    .subscribe((x) => {
        console.log(x);
    });
}

const container = document.getElementById('root');
container.innerHTML = '<button>click</button>';
container.addEventListener('click', async () => {
    console.log('start');

    const result = await concurrencyRequest([], 2);
    
    console.log('end');
    
    console.log(result);
}, false);




```
